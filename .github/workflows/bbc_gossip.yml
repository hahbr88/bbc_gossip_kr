name: BBC Gossip KR Daily

on:
  schedule:
    # 09:00 KST = 00:00 UTC (정시에 최대한 가깝게: 전후 몇 분 분산)
    - cron: "59 23 * * *" # 08:59 KST
    - cron: "0 0 * * *"   # 09:00 KST
    - cron: "1 0 * * *"   # 09:01 KST
    - cron: "2 0 * * *"   # 09:02 KST
    - cron: "3 0 * * *"   # 09:03 KST
  workflow_dispatch:
    inputs:
      force_run:
        description: "Ignore KST markers and run anyway"
        required: false
        default: "false"

# 겹쳐서 돌면 하나만 유지 (분산 크론에선 true보다 false가 안전)
concurrency:
  group: bbc-gossip-daily
  cancel-in-progress: false

# Issue를 읽고/작성하려면 권한 필요
permissions:
  contents: read
  actions: read
  issues: write

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    env:
      SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      DRY_RUN: "0"
      TZ: Asia/Seoul
      GH_TOKEN: ${{ github.token }} # gh CLI 인증용

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # ---- 날짜 키 계산 ----
      - name: Compute KST day key
        id: day
        shell: bash
        run: |
          echo "date=$(TZ=Asia/Seoul date +%F)" >> "$GITHUB_OUTPUT"
          echo "kst_now=$(TZ=Asia/Seoul date +%FT%T%z)" >> "$GITHUB_OUTPUT"
          echo "utc_now=$(date -u +%FT%TZ)" >> "$GITHUB_OUTPUT"

      # ---- 가드 1) Cache 마커 ----
      - name: Restore daily run marker (cache)
        id: cache_marker
        uses: actions/cache/restore@v4
        with:
          path: .run-marker
          key: bbc-gossip-ran-${{ steps.day.outputs.date }}

      - name: Init run guard
        id: guard
        shell: bash
        run: |
          echo "should_run=true" >> "$GITHUB_OUTPUT"
          if [ "${{ github.event.inputs.force_run }}" = "true" ]; then
            echo "force_run=true"
            echo "force_run=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Guard via cache (KST)
        if: steps.cache_marker.outputs.cache-hit == 'true' && steps.guard.outputs.force_run != 'true'
        shell: bash
        run: |
          echo "Already ran today via CACHE. KST=${{ steps.day.outputs.date }} now=${{ steps.day.outputs.kst_now }}"
          if [ -f ".run-marker/ran.txt" ]; then
            echo "----- marker (.run-marker/ran.txt) -----"
            cat .run-marker/ran.txt
            echo "---------------------------------------"
          fi
          echo "should_run=false"
          echo "should_run=false" >> "$GITHUB_OUTPUT"
        id: guard_cache

      # ---- 가드 2) GitHub Issue 마커 ----
      # 런 마커용 이슈를 찾거나(없으면) 자동 생성
      - name: Find or create run-marker issue
        id: marker_issue
        if: steps.guard_cache.outputs.should_run != 'false'
        shell: bash
        run: |
          set -euo pipefail
          REPO="${GITHUB_REPOSITORY}"
          TITLE="BBC Gossip Run Marker"
          QUERY="repo:${REPO} in:title \"${TITLE}\""

          # Use gh issue list to avoid REST search API permission issues
          ISSUE_NUMBER=""
          for attempt in 1 2 3; do
            if ISSUE_NUMBER="$(gh issue list --repo "${REPO}" --state all \
              --search "\"${TITLE}\" in:title" --json number \
              --jq '.[0].number // empty' 2>gh_api_err.txt)"; then
              break
            fi
            echo "Warning: issue list failed (attempt ${attempt}/3). Retrying in 5s..." >&2
            cat gh_api_err.txt >&2
            sleep 5
          done
          if [ -z "${ISSUE_NUMBER}" ] && [ -s gh_api_err.txt ]; then
            echo "Error: failed to list issues via GitHub CLI after 3 attempts."
            cat gh_api_err.txt >&2
            exit 1
          fi
          rm -f gh_api_err.txt

          if [ -z "${ISSUE_NUMBER}" ]; then
            echo "No marker issue found. Creating one..."
            if ! ISSUE_URL="$(gh issue create --title "${TITLE}" --body "자동 생성된 런 마커 이슈입니다. 매일 실행 기록을 코멘트로 남깁니다." --repo "${REPO}" 2>gh_issue_err.txt)"; then
              echo "Error: failed to create marker issue."
              echo "Check: repository access, Issues enabled, and token permissions (issues: write)."
              cat gh_issue_err.txt >&2
              exit 1
            fi
            rm -f gh_issue_err.txt
            ISSUE_NUMBER="$(echo "$ISSUE_URL" | sed -n 's/.*\/issues\/\([0-9]\+\).*/\1/p')"
          fi

          if [ -z "${ISSUE_NUMBER}" ] || ! echo "${ISSUE_NUMBER}" | grep -Eq '^[0-9]+$'; then
            echo "Error: invalid issue number: ${ISSUE_NUMBER}"
            exit 1
          fi

          echo "issue_number=${ISSUE_NUMBER}" >> "$GITHUB_OUTPUT"
          echo "Using marker issue #${ISSUE_NUMBER}"

      # 오늘(KST) 실행 마커 코멘트가 이미 있으면 스킵
      - name: Guard via issue comment (KST)
        if: steps.guard_cache.outputs.should_run != 'false' && steps.guard.outputs.force_run != 'true'
        shell: bash
        run: |
          set -euo pipefail
          REPO="${GITHUB_REPOSITORY}"
          ISSUE="${{ steps.marker_issue.outputs.issue_number }}"
          DAY="${{ steps.day.outputs.date }}"

          # 최근 코멘트 100개에서 오늘 마커 존재 여부 체크
          # NOTE: 
          # jq env.DAY was empty (not exported), so test("KST=") matched all comments. jq env.DAY가 비어 있어 test("KST=")가 모든 코멘트를 매칭했었음.
          # Inject DAY directly to ensure only today's KST marker matches. DAY를 직접 삽입해 오늘 KST 마커만 매칭되도록 수정.
          HIT="$(gh api -X GET "repos/${REPO}/issues/${ISSUE}/comments?per_page=100" \
            --jq "[.[].body] | map(select(test(\"KST=${DAY}\"))) | length")"

          if [ "${HIT}" != "0" ]; then
            echo "Already ran today via ISSUE comment. KST=${DAY}"
            echo "should_run=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "No issue marker for today. Continue."
        id: guard_issue

      # 오늘 처음 실행이면 marker 파일도 생성 (cache 저장용)
      - name: Create daily run marker file
        if: steps.guard_cache.outputs.should_run != 'false' && steps.guard_issue.outputs.should_run != 'false'
        shell: bash
        run: |
          mkdir -p .run-marker
          echo "ran_at_utc=${{ steps.day.outputs.utc_now }}" > .run-marker/ran.txt
          echo "ran_at_kst=${{ steps.day.outputs.kst_now }}" >> .run-marker/ran.txt
          echo "run_id=${{ github.run_id }}" >> .run-marker/ran.txt
          echo "attempt=${{ github.run_attempt }}" >> .run-marker/ran.txt
          echo "ref=${{ github.ref }}" >> .run-marker/ran.txt
          cat .run-marker/ran.txt

      # ---- 실제 실행 ----
      - name: Run (save log)
        if: steps.guard_cache.outputs.should_run != 'false' && steps.guard_issue.outputs.should_run != 'false'
        shell: bash
        run: |
          mkdir -p logs
          LOG_DATE="${{ steps.day.outputs.date }}"
          python app.py 2>&1 | tee "logs/bbc-gossip-${{ github.run_id }}-${LOG_DATE}.log"

      - name: Upload logs
        if: steps.guard_cache.outputs.should_run != 'false' && steps.guard_issue.outputs.should_run != 'false'
        uses: actions/upload-artifact@v4
        with:
          name: bbc-gossip-logs-${{ github.run_id }}
          path: logs/*.log
          retention-days: 14

      - name: Upload run marker (always)
        if: steps.guard_cache.outputs.should_run != 'false' && steps.guard_issue.outputs.should_run != 'false'
        uses: actions/upload-artifact@v4
        with:
          name: bbc-gossip-run-marker-${{ github.run_id }}
          path: .run-marker/ran.txt
          retention-days: 14

      # 성공하면: Issue 코멘트로 오늘 실행 마커 남김 (이게 “최종 보증 장치”)
      - name: Write success marker to issue
        if: success() && steps.guard_cache.outputs.should_run != 'false' && steps.guard_issue.outputs.should_run != 'false'
        shell: bash
        run: |
          set -euo pipefail
          REPO="${GITHUB_REPOSITORY}"
          ISSUE="${{ steps.marker_issue.outputs.issue_number }}"
          DAY="${{ steps.day.outputs.date }}"

          BODY=$(cat <<EOF
          ### Daily run success
          - KST=${DAY}
          - ran_at_kst=${{ steps.day.outputs.kst_now }}
          - ran_at_utc=${{ steps.day.outputs.utc_now }}
          - run_id=${{ github.run_id }}
          - attempt=${{ github.run_attempt }}
          EOF
          )

          gh api -X POST "repos/${REPO}/issues/${ISSUE}/comments" -f body="$BODY"
          echo "Wrote issue marker on #${ISSUE} for KST=${DAY}"

      # ---- cache save: 있으면 좋고 없어도 issue 마커가 최종 안전장치 ----
      - name: Save daily run marker (cache) - attempt 1
        id: save1
        if: success() && steps.guard_cache.outputs.should_run != 'false' && steps.guard_issue.outputs.should_run != 'false'
        continue-on-error: true
        uses: actions/cache/save@v4
        with:
          path: .run-marker
          key: bbc-gossip-ran-${{ steps.day.outputs.date }}

      - name: Save daily run marker (cache) - attempt 2
        id: save2
        if: success() && steps.save1.outcome != 'success' && steps.guard_cache.outputs.should_run != 'false' && steps.guard_issue.outputs.should_run != 'false'
        continue-on-error: true
        uses: actions/cache/save@v4
        with:
          path: .run-marker
          key: bbc-gossip-ran-${{ steps.day.outputs.date }}

      - name: Save daily run marker (cache) - attempt 3
        id: save3
        if: success() && steps.save2.outcome != 'success' && steps.guard_cache.outputs.should_run != 'false' && steps.guard_issue.outputs.should_run != 'false'
        continue-on-error: true
        uses: actions/cache/save@v4
        with:
          path: .run-marker
          key: bbc-gossip-ran-${{ steps.day.outputs.date }}

      - name: Warn if cache save failed (issue marker already written)
        if: success() && steps.save3.outcome != 'success' && steps.guard_cache.outputs.should_run != 'false' && steps.guard_issue.outputs.should_run != 'false'
        shell: bash
        run: |
          echo "::warning title=Cache save failed::Cache save failed after 3 attempts. Issue marker exists, so next cron should still skip. KST=${{ steps.day.outputs.date }}"
